#!/bin/sh
set -eu

log() { printf "%s\n" "${@}" >&2; }

# Replace illegal filesystem chars with underscore
replace_special() { tr '"*/:<>?\|' '_'; }

for FNAME in "${@}"; do
    if ! [ -f "${FNAME}" ]; then
        log "[W]: ${FNAME} not a regular file, skipping!"
        continue
    fi

    EXT="${FNAME##*.}"

    # If no / in FNAME, prepend ./
    if [ "${FNAME%/*}" = "${FNAME}" ]; then
        FNAME="./${FNAME}"
    fi

    TITLE="$( fftag -file "${FNAME}" -tag TITLE )" || {
        log "[W]: ${FNAME} missing TITLE tag, skipping!"
        continue
    }
    ARTIST="$(fftag -file "${FNAME}" -tag ARTIST)" || {
        log "[W]: ${FNAME} missing ARTIST tag, skipping!"
        continue
    }

    TRACK="$( fftag -file "${FNAME}" -tag TRACK )" || TRACK=""
    if [ "${TRACK}" = "" ] || [ "${TRACK}" -le 9 ]; then
        TRACK="0${TRACK}"
    fi

    TITLE="$( printf "%s" "${TITLE}"  | replace_special)"
    ARTIST="$(printf "%s" "${ARTIST}" | replace_special)"

    if [ "${TRACK}" != "" ]; then
        NEW_FNAME="$(printf "%s. %s - %s.%s\n" "${TRACK}" "${ARTIST}" "${TITLE}" "${EXT}")"
    else
        NEW_FNAME="$(printf "%s - %s.%s\n" "${ARTIST}" "${TITLE}" "${EXT}")"
    fi
    PDIR="${FNAME%/*}"
    NEW_FNAME="${PDIR}/${NEW_FNAME}"

    if [ -e "${NEW_FNAME}" ]; then
        log "[W]: ${NEW_FNAME} already exists, skipping!"
        continue
    fi

    mv -v "${FNAME}" "${NEW_FNAME}"
done
