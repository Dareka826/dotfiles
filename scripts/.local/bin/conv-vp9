#!/bin/sh
set -eu

_conv_1pass() {
    local FILE="${1}"
    local CRF="${2}"
    local OUT_FILE="${3}"
    shift 3

    ffmpeg \
        -hide_banner \
        -i "${FILE}" \
        -c:v libvpx-vp9 \
        -crf "${CRF}" \
        -b:v 0 \
        -speed 1 \
        -c:a libopus \
        -b:a 128k \
        "${OUT_FILE}" || return 1
}

_conv_2pass() {
    local FILE="${1}"
    local CRF="${2}"
    local OUT_FILE="${3}"
    shift 3

    ffmpeg \
        -hide_banner \
        -i "${FILE}" \
        -c:v libvpx-vp9 \
        -crf "${CRF}" \
        -b:v 0 \
        -speed 1 \
        -pass 1 \
        -an \
        -f null \
        /dev/null || return 1

    ffmpeg \
        -hide_banner \
        -i "${FILE}" \
        -c:v libvpx-vp9 \
        -crf "${CRF}" \
        -b:v 0 \
        -speed 1 \
        -pass 2 \
        -c:a libopus \
        -b:a 128k \
        "${OUT_FILE}" || return 1
}

_conv_crf() {
    local FILE="${1}"
    local CRF="${2}"
    shift 2

    [ -e "${FILE}" ] || exit 1
    [ -n "${CRF}"  ] || exit 1
    [ "${CRF}" -ge 0  ] || exit 1
    [ "${CRF}" -le 63 ] || exit 1

    local OUT_FILE="${FILE}.crf${CRF}.webm"

    local SUCCESS="1"
    # _conv_1pass "${FILE}" "${CRF}" "${OUT_FILE}" || SUCCESS="0"
    _conv_2pass "${FILE}" "${CRF}" "${OUT_FILE}" || SUCCESS="0"

    if [ "${SUCCESS}" = "1" ]; then
        touch -r "${FILE}" "${OUT_FILE}"
        touch "${OUT_FILE}.done"
        printf "conv: %s\n" "${FILE}"
    else
        printf "fail: %s\n" "${FILE}"
    fi
}

_CRF="30"
[ -e "${1}" ] || { _CRF="${1}"; shift 1; }

for _FILE in "$@"; do
    _conv_crf "${_FILE}" "${_CRF}"
done
