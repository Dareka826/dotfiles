#!/bin/sh
set -eu

_conv_crf() {
    local FILE="${1}"
    local CRF="${2}"
    shift 2

    [ -n "${CRF}" ] || CRF="30"

    [ -e "${FILE}" ] || exit 1
    [ "${CRF}" -ge 0  ] || exit 1
    [ "${CRF}" -le 63 ] || exit 1

    local SUCCESS="1"
    ffmpeg \
        -hide_banner \
        -i "${FILE}" \
        -c:v libvpx-vp9 \
        -crf "${CRF}" \
        -b:v 0 \
        -c:a libopus \
        -b:a 128k \
        "${FILE}.crf${CRF}.webm" || SUCCESS="0"

    if [ "${SUCCESS}" = "1" ]; then
        printf "conv: %s\n" "${FILE}"
    else
        printf "fail: %s\n" "${FILE}"
        exit 1
    fi
}

for _FILE in "$@"; do
    _conv_crf "${_FILE}" 30
done
