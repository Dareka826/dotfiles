#!/bin/sh
set -eu

TMP_OUT=""
cleanup() {
    { [ -n "${TMP_OUT}" ] && [ -e "${TMP_OUT}" ]; } \
        && rm "${TMP_OUT}" || :
}
trap cleanup TERM INT HUP EXIT

for FNAME in "$@"; do
    [ "${FNAME}" ] || continue
    [ "${FNAME##*.}" = "png" ] || continue

    TMP_OUT="$(mktemp --suffix=".jpg")"

    if ! convert "${FNAME}" -quality 99 "${TMP_OUT}"; then
        printf "Error: convert failed: %s\n" "${FNAME}"
        rm "${TMP_OUT}"
        continue
    fi

    if [ "$(stat -c "%s" "${TMP_OUT}")" -gt "$(stat -c "%s" "${FNAME}")" ]; then
        printf "Skip: new file larger than original: %s\n" "${FNAME}"
        rm "${TMP_OUT}"
        continue
    fi

    touch -r "${FNAME}" "${TMP_OUT}"
    mv "${TMP_OUT}" "${FNAME%.png}.jpg" && \
        rm "${FNAME}"
    printf "Conv: %s\n" "${FNAME}"
done
